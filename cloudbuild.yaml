steps:
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args:
    - '-eEuo'
    - 'pipefail'
    - '-c'
    - |-
      ts=`date +%Y%m%d%H%M`
      job_id="simple_stock_training_$ts"
      pwd
      key_id=`gcloud beta secrets versions access latest --secret=APCA_API_KEY_ID`
      secret=`gcloud beta secrets versions access latest --secret=APCA_API_SECRET_KEY`
      gcloud ai-platform jobs submit training $job_id --module-name trainer.lstm_stock --package-path trainer/ \
      --region "us-central1" \
      --python-version 3.7 \
      --master-image-uri=gcr.io/cloud-ml-public/training/pytorch-cpu.1-4 \
      --job-dir "gs://iwasnothing-cloudml-job-dir/simple-stock-train" \
      -- --key-id=$key_id --secret=$secret